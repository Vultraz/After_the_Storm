#textdomain wesnoth-After_the_Storm

[scenario]
    id=04_Shifting_Allegiances
    name= _ "Shifting Allegiances"
    {MAP 04_Shifting_Allegiances.map}
    {TURNS 34 33 32}
    next_scenario=05_The_Eastern_Front

    {END_OF_PLAYABLE_SCENARIOS}

    {D_DEATHS}

    {SCENARIO_MUSIC "nunc_dimittis.ogg"}
    {EXTRA_SCENARIO_MUSIC "breaking_the_chains.ogg"}
    {EXTRA_SCENARIO_MUSIC "battle.ogg"}

    {STORYTXT_SHIFTING_ALLEGIANCES}

    {DAWN2}
    {MORNING2}
    {MIDDAY2}
    {AFTERNOON2}
    {DUSK2}
    {LONGDARK1}
    {LONGDARK2}
    {LONGDARK3}
    {LONGDARK4}
    {DAWN1}
    {MORNING1}
    {MIDDAY1}
    {AFTERNOON1}
    {DUSK1}
    {SHORTDARK}

    # wmllint: validate-off
    [side]
        side=1
        controller=human
        save_id=player
        team_name=good
        user_team_name= _ "team_name^Elynia"

        {CHARACTER_STATS_ELYNIA}
    [/side]

    [side]
        side=2
        team_name=rebels
        user_team_name= _ "team_name^Demons"
        {CHAOS_FLAG}
        color=black

        {CHARACTER_STATS_ELORRAN}
        canrecruit=yes
        facing=sw

        {GOLD 200 225 250}
        {INCOME 0 1 2}
        recruit=Demon,Faerie Sprite,Animated Rock

        {ai/aliases/stable_singleplayer.cfg}
        [ai]
            {AI_SIMPLE_ALWAYS_ASPECT passive_leader no}
            {AI_SIMPLE_ALWAYS_ASPECT grouping defensive}
            {AI_SIMPLE_ALWAYS_ASPECT recruitment_pattern "archer,mixed fighter,fighter,fighter,fighter,mixed fighter"}
        [/ai]
    [/side]
    # wmllint: validate-on

    [side]
        side=3
        team_name=shaxthals
        user_team_name= _ "team_name^Shaxthals"
        {CHAOS_FLAG}
        hidden=yes
        no_leader=yes

        recruit=Shaxthal Drone,Shaxthal Rayblade,Shaxthal Razorbird

        {ai/aliases/stable_singleplayer.cfg}
        [ai]
            {AI_SIMPLE_ALWAYS_ASPECT passive_leader no}
            {AI_SIMPLE_ALWAYS_ASPECT attack_depth ({DIFF 2 3 4})}
            {AI_SIMPLE_ALWAYS_ASPECT recruitment_pattern "mixed fighter,scout,mixed fighter,fighter,mixed fighter,mixed fighter"}
        [/ai]
    [/side]

    [side]
        side=4
        team_name=shaxthals
        user_team_name= _ "team_name^Shaxthals"
        {CHAOS_FLAG}
        hidden=yes
        no_leader=yes

        recruit=Shaxthal Runner Drone,Shaxthal Rayblade

        {ai/aliases/stable_singleplayer.cfg}
        [ai]
            {AI_SIMPLE_ALWAYS_ASPECT passive_leader no}
            {AI_SIMPLE_ALWAYS_ASPECT attack_depth ({DIFF 2 3 4})}
            {AI_SIMPLE_ALWAYS_ASPECT recruitment_pattern "fighter,mixed fighter,mixed fighter,mixed fighter"}
        [/ai]
    [/side]

    {STARTING_VILLAGES 1 8}
    {STARTING_VILLAGES 2 10}

    # wmlindent: start ignoring
    {FORCE_CHANCE_TO_HIT () (
        id=Elorran
        [or]
            id=Tara
        [/or]
        [or]
            id=Anya
        [/or]
    ) 0 ()}
    # wmlindent: stop ignoring

    [event]
        name=prestart
        {RECALL_DURVAN_AT_LOCATION  6 20}
        {RECALL_ALLYNA_AT_LOCATION  7 21}
        {RECALL_ZYNARA_AT_LOCATION  5 21}

        {MODIFY_UNIT (id=Allyna) experience 0}
        {MODIFY_UNIT (side=1) facing ne}

        {OBJECTIVES (
            {OBJECTIVE_VICTORY ( _ "Defeat the enemy leader")}

            {OBJECTIVE_DEFEAT  ( _ "Death of Elynia")}
            {OBJECTIVE_DEFEAT  ( _ "Death of Durvan")}
            {OBJECTIVE_DEFEAT  ( _ "Death of Zynara")}

            {TURNS_RUN_OUT}

            {OBJECTIVE_CARRYOVER}
        )}

        [hide_unit]
            id=Elorran
        [/hide_unit]

        [unit]
            side=2
            type=Elvish Marksman
            gender=female
            x,y=12,16
            hitpoints,max_hitpoints=1,1
            moves,max_moves=0,0
            experience,max_experience=0,0
            facing=se
            [status]
                petrified=yes
            [/status]
        [/unit]

        [unit]
            side=2
            type=Elvish Marksman
            gender=male
            x,y=16,17
            hitpoints,max_hitpoints=1,1
            moves,max_moves=0,0
            experience,max_experience=0,0
            facing=sw
            [status]
                petrified=yes
            [/status]
        [/unit]
    [/event]

    [event]
        name=start
        [message]
            speaker=Durvan
            message= _ "It’s really been a long trip. Are we there yet?"
        [/message]

        [message]
            speaker=Elynia
            message= _ "No. The eastern border should be another couple of days away if we don’t stop to rest."
        [/message]

        [message]
            speaker=Allyna
            message= _ "We could have avoided all this if you knew how to use the full extent of the Ruby of Fire’s power."
        [/message]

        [message]
            speaker=Elynia
            message= _ "Right. But—"
        [/message]

        [redraw][/redraw]

        [delay]
            time=1000
        [/delay]

        [message]
            speaker=Elynia
            message= _ "<i>(visibly angered)</i> You can’t possibly know about the Ruby of Fire! Who are you?"
        [/message]

        {MODIFY_UNIT (id=Allyna) facing sw}

        [message]
            speaker=Allyna
            message= _ "I’m sorry for lying to you. I really like you, but I needed you to come here..."
        [/message]

        {INCIDENTAL_MUSIC "the_dangerous_symphony.ogg"}

        [animate_unit]
            [filter]
                id=Allyna
            [/filter]
            flag=levelout
            with_bars=yes
        [/animate_unit]

        [store_unit]
            [filter]
                id=Allyna
            [/filter]
            variable=allyna_store
            kill=yes
        [/store_unit]

        [unit]
            # NOTE: Her experience and HP are not preserved. This is intentional.
            {CHARACTER_STATS_ANYA}
            #placement=map_overwrite
            x,y=$allyna_store.x,$allyna_store.y
            facing=$allyna_store.facing
            side=2
        [/unit]
        {NO_UPKEEP}

        [animate_unit]
            [filter]
                id=Anya
            [/filter]
            flag=levelin
            with_bars=yes
        [/animate_unit]

        {CLEAR_VARIABLE allyna_store}

        [delay]
            time=500
        [/delay]

        [message]
            speaker=Zynara
            message= _ "An impostor!"
        [/message]

        [message]
            speaker=Anya
            message= _ "No, I simply needed to disguise myself as a helpless human girl so I’d be allowed to travel with you and guide you to this place."
        [/message]

        {MOVE_UNIT (id=Anya)  9 20}
        {MODIFY_UNIT (id=Anya) facing sw}

#define SA_STATUE_SHAPESHIFT _X _Y _WML
    [animate_unit]
        [filter]
            x={_X}
            y={_Y}
        [/filter]
        flag=levelout
        with_bars=yes
    [/animate_unit]

    [store_unit]
        [filter]
            x={_X}
            y={_Y}
        [/filter]
        kill=yes
        variable=statue_store
        mode=replace
    [/store_unit]

    [unit]
        x=$statue_store.x
        y=$statue_store.y
        facing=$statue_store.facing
        side=2
        random_traits,random_gender,generate_name=no,no,no
        {_WML}
    [/unit]

    [animate_unit]
        [filter]
            x=$statue_store.x
            y=$statue_store.y
        [/filter]
        flag=levelin
        with_bars=yes
    [/animate_unit]
#enddef

        {SA_STATUE_SHAPESHIFT 12 16 (
            id=Narango
            name= _ "Narango"
            type=Demon
            [modifications]
                {TRAIT_STRONG}
                {TRAIT_RESILIENT}
            [/modifications]
        )}
        {SA_STATUE_SHAPESHIFT 16 17 (
            id=Lydia
            name= _ "Lydia"
            type=Demon Zephyr
            gender=female
            [modifications]
                {TRAIT_DEXTROUS}
                {TRAIT_QUICK}
            [/modifications]
        )}

#undef SA_STATUE_SHAPESHIFT

        [teleport]
            [filter]
                id=Elorran
            [/filter]
            x,y=10,20
        [/teleport]

        {MODIFY_UNIT (id=Elorran) facing sw}

        [unhide_unit]
            id=Elorran
        [/unhide_unit]

        [animate_unit]
            [filter]
                id=Elorran
            [/filter]
            flag=post_teleport
            with_bars=yes
        [/animate_unit]

        [unit]
            {CHARACTER_STATS_TARA}
            side=2
            x,y=9,19
            facing=sw
        [/unit]
        {NO_UPKEEP}

        [animate_unit]
            [filter]
                id=Tara
            [/filter]
            flag=post_teleport
            with_bars=yes
        [/animate_unit]

        [redraw][/redraw]

        [delay]
            time=500
        [/delay]

        [message]
            speaker=Elynia
            message= _ "What do you want from us?"
        [/message]

        [message]
            speaker=Elorran
            message= _ "We just want your staff, or to be more specific, the Ruby of Fire, which is part of it."
        [/message]

        [message]
            speaker=Elynia
            message= _ "You know you already tried this once and didn’t succeed."
        [/message]

        [message]
            speaker=Elorran
            message= _ "Actually, I don’t. Are you speaking of someone else?"
        [/message]

        [message]
            speaker=Zynara
            message= _ "My lady, we are wasting precious time here! Let’s just get rid of them!"
        [/message]

        [message]
            speaker=Elynia
            message= _ "The power of the Ruby of Fire is too great and too evil for it to fall into the wrong hands. You fiends shall not get this artifact as long as I live!"
        [/message]

        [message]
            speaker=Elorran
            message= _ "So be it, then. I was hoping to achieve something with a more civilized approach, but I guess diplomacy has become a thing of the past."
        [/message]

        [store_starting_location]
            side=2
        [/store_starting_location]

#define SA_TELEPORT_BACK _ID
    [animate_unit]
        [filter]
            id={_ID}
        [/filter]
        flag=pre_teleport
        with_bars=yes
    [/animate_unit]

    [teleport]
        [filter]
            id={_ID}
        [/filter]
        x=$location.x
        y=$location.y
    [/teleport]

    [redraw][/redraw]
#enddef

        {SA_TELEPORT_BACK Elorran}

        {SA_TELEPORT_BACK Tara}

        [message]
            speaker=Anya
            message= _ "I’m truly sorry. It wasn’t my intention for things to come to this."
        [/message]

        {SA_TELEPORT_BACK Anya}

#undef SA_TELEPORT_BACK

        [redraw][/redraw]

        [delay]
            time=500
        [/delay]

        [message]
            speaker=Durvan
            message= _ "What... was that?"
        [/message]

        [message]
            speaker=Elynia
            message= _ "I’m not sure. There’s something very unusual about these demons, aside from the fact that there’s two faerie beings allied with them."
        [/message]

        [message]
            speaker=Zynara
            message= _ "Let’s purge this plague out of the country!"
        [/message]

        [allow_recruit]
            side=1
            type=Vampire Bat,Ghost,Skeleton,Skeleton Archer,Walking Corpse
        [/allow_recruit]

        [message]
            speaker=narrator
            image=wesnoth-icon.png
            message= _ "You can now recruit undead units!"
        [/message]
    [/event]

    [event]
        name=turn 2
        [sound]
            name={SOUND_LIST:BIOMECHANICAL_ROAM}
        [/sound]

        [message]
            speaker=Durvan
            message= _ "Did you all hear that?"
        [/message]

        [message]
            speaker=Elynia
            message= _ "That’s the sound of bad news — shaxthal creatures are approaching."
        [/message]
    [/event]

    [event]
        name=turn 3

        [move_unit_fake]
            type=Shaxthal War Drone
            side=4
            x=54,52
            y=22,21
        [/move_unit_fake]

        [unit]
            canrecruit=yes
            type=Shaxthal War Drone
            side=4
            x,y=52,21
            facing=nw
            [modifications]
                {TRAIT_BIOMECHANICAL}
                {TRAIT_STRONG}
            [/modifications]
        [/unit]

        {FAKE_RECRUIT 4 (Shaxthal Rayblade) 53 21}
        {FAKE_RECRUIT 4 (Shaxthal Runner Drone) 52 22}
        {FAKE_RECRUIT 4 (Shaxthal Runner Drone) 51 23}


        [move_unit_fake]
            type=Shaxthal Enforcer Drone
            variation=surface
            side=3
            x=40,36
            y=26,24
        [/move_unit_fake]

        [unit]
            canrecruit=yes
            type=Shaxthal Enforcer Drone
            variation=surface
            side=3
            x,y=36,24
            facing=nw
            [modifications]
                {TRAIT_BIOMECHANICAL}
                {TRAIT_ARMORED}
            [/modifications]
        [/unit]

        [message]
            speaker=Zynara
            message= _ "They have arrived!"
        [/message]

        [message]
            speaker=Elorran
            message= _ "Curse Uria! They have found us!"
        [/message]

        [modify_side]
            side=3
            hidden=no
            {GOLD 150 175 200}
        [/modify_side]

        [modify_side]
            side=4
            hidden=no
            {GOLD 180 200 220}
        [/modify_side]
    [/event]

    [event]
        name=turn 5
        [message]
            speaker=Durvan
            message= _ "Those metallic beasts don’t seem interested in us as much as they are interested in our foes, but why?"
        [/message]

        [message]
            speaker=Elorran
            message= _ "Lady of Light, I’d like to call a truce. These creatures are our enemies too, and we don’t really want to get involved in a slaughter."
        [/message]

        [message]
            speaker=Elynia
            message= _ "Why should my side accede? Don’t you all work for Uria?"
        [/message]

        [message]
            speaker=Anya
            message= _ "We don’t! We are struggling <i>against</i> her!"
        [/message]

        [message]
            speaker=Zynara
            message= _ "My lady, those demons cannot be trusted! They must be staging a trap, posing as enemies of Uria!"
        [/message]

        [role]
            role=doubtful fairy
            race=fairy
            [not]
                id=Elynia
            [/not]
        [/role]

        [role]
            role=suspecting human
            race=human
            [not]
                id=Zynara
            [/not]
            [not]
                id=Durvan
            [/not]
        [/role]

        [if]
            [have_unit]
                role=doubtful fairy
            [/have_unit]
            [have_unit]
                role=suspecting human
            [/have_unit]
            [then]
                [message]
                    role=doubtful fairy
                    message= _ "I don’t know, they do seem to have a few of us amongst them. I am fairly sure our kind wouldn’t ally with demons without a very good reason."
                [/message]

                [message]
                    role=suspecting human
                    message= _ "And what if that reason is destroying us? Your kind can’t be trusted!"
                [/message]
            [/then]
        [/if]

        [message]
            speaker=Durvan
            message= _ "My lady?"
        [/message]

        [message]
            speaker=Elynia
            message= _ "(<i>What would Galas and Anlindë have done in this situation?</i>)"
        [/message]

        [message]
            speaker=Zynara
            message= _ "My lady, you must decide now!"
        [/message]

#ifdef __UNUSED__
        [message]
            speaker=Elynia
            message= _ "I know..."
            [option]
                message= _ "Let’s cooperate with these strange demons and repel the shaxthal incursion before they infest the countryside. We’ll decide what to do about them later."
                [command][/command]
            [/option]
            [option]
                message= _ "Allying ourselves with Uria’s spawns would be a great dishonor for the memory of our fallen friends."
                [command]
                    [message]
                        speaker=Elorran
                        message= _ "That’s an unfortunate choice."
                    [/message]

                    {ENDLEVEL_DEFEAT}
                [/command]
            [/option]
        [/message]
#endif

        [message]
            speaker=Elynia
            message= _ "Let’s cooperate with these strange demons and repel the shaxthal incursion before they infest the countryside. We’ll decide what to do about them later."
        [/message]

        [message]
            speaker=Zynara
            message= _ "This is ridiculous! My master must have overestimated your ability to command!"
        [/message]

        [message]
            speaker=Elynia
            message= _ "Your master would have been destroyed if Galas and Anlindë hadn’t been at the command of the elvish troops. They gave him a chance to redeem himself. If it weren’t for that, none of us would be here today discussing this."
        [/message]

        [message]
            speaker=Durvan
            message= _ "Very well, let’s do this!"
        [/message]

        [modify_side]
            side=2
            team_name=good
        [/modify_side]
    [/event]

    [event]
        name=enemies defeated

        {ENDLEVEL_VICTORY yes}
    [/event]

    [event]
        name=victory
        [message]
            speaker=Anya
            message= _ "Yes! We did it! We did it together!"
        [/message]
    [/event]
[/scenario]

# kate: indent-mode normal; encoding utf-8; space-indent on;
