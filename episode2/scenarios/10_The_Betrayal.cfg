#textdomain wesnoth-After_the_Storm

[scenario]
    id=10_The_Betrayal
    name= _ "The Betrayal"
    {MAP 10_The_Betrayal.map}
    {TURNS 6 5 4}
    next_scenario=11_A_Final_Confrontation
    victory_when_enemies_defeated=no

    {END_OF_PLAYABLE_SCENARIOS}

    {E_DEATHS}

    {SCENARIO_MUSIC       "breaking_the_chains.ogg"} {CONTINUE_PLAYING_STORY_MUSIC_FIRST}
    {EXTRA_SCENARIO_MUSIC "legends_of_the_north.ogg"}

    {STORYTXT_THE_BETRAYAL}

    {INDOORS_HIVE}

#define TB_NO_ECONOMY
    gold,village_gold=0,0
    {NO_INCOME}
#enddef

#define TB_SHARED_AI_ASPECTS
    {AI_SIMPLE_ALWAYS_ASPECT aggression 5.00}
    {AI_SIMPLE_ALWAYS_ASPECT caution    0.00}
    {AI_SIMPLE_ALWAYS_ASPECT grouping     no}
#enddef

    {SPAWN_CONTROLLER}

    # wmllint: validate-off
    [side]
        side=1
        controller=human
        save_id=player
        team_name=good
        user_team_name= _ "team_name^Elynia"

        {GOLD 140 120 100}
        {INCOME 3 2 2}

        shroud=yes

        {CHARACTER_STATS_ELYNIA}
    [/side]
    # wmllint: validate-on

    [side]
        side=2
        team_name=evil
        user_team_name= _ "team_name^Dark Hive"
        {CHAOS_FLAG}

        recruit=Shaxthal Drone,Automaton,Chaos Hound
        {GOLD 75 80 95}

        {ai/aliases/stable_singleplayer.cfg}
        [ai]
            {AI_SIMPLE_ALWAYS_ASPECT aggression 5.00}
            {AI_SIMPLE_ALWAYS_ASPECT caution    0.00}
            {AI_SIMPLE_ALWAYS_ASPECT attack_depth {DIFF 2 3 4} }
            {AI_SIMPLE_ALWAYS_ASPECT recruitment_pattern "fighter,mixed fighter,mixed fighter,fighter,scout"}
        [/ai]

        canrecruit=yes
        type=Faerie Avatar
        id=Lady of Light
        name= _ "Lady of Light"
        #profile="portraits/ivyel.png"
        facing=se
        [modifications]
            {TRAIT_RESILIENT}
            {TRAIT_DEXTROUS}
        [/modifications]

        [village]
            x,y=24,32
        [/village]
        [village]
            x,y=19,32
        [/village]
    [/side]

    [side]
        side=3
        team_name=evil
        user_team_name= _ "team_name^Dark Hive"
        {CHAOS_FLAG}

        recruit=Chaos Invader,Chaos Invoker,Chaos Headhunter,Shaxthal Runner Drone
        {GOLD 120 130 150}

        {ai/aliases/stable_singleplayer.cfg}
        [ai]
            {AI_SIMPLE_ALWAYS_ASPECT aggression           1.00}
            {AI_SIMPLE_ALWAYS_ASPECT caution              0.00}
            {AI_SIMPLE_ALWAYS_ASPECT attack_depth         {DIFF 3 4 5} }
            {AI_SIMPLE_ALWAYS_ASPECT recruitment_pattern "archer,scout,scout,fighter,mixed fighter,archer"}
        [/ai]

        canrecruit=yes
        type=Hell Guardian
        id=Stalygvan
        name= _ "Stalygvan"
        facing=nw
        [modifications]
            {TRAIT_STRONG}
            {TRAIT_RESILIENT}
        [/modifications]
    [/side]

    [side]
        side=4
        team_name=evil
        user_team_name= _ "team_name^Dark Hive"
        {CHAOS_FLAG}

        recruit=Shaxthal Drone,Automaton,Chaos Headhunter,Chaos Bowman
        {GOLD 150 170 190}

        {ai/aliases/stable_singleplayer.cfg}
        [ai]
            {AI_SIMPLE_ALWAYS_ASPECT attack_depth         {DIFF 2 3 4} }
            {AI_SIMPLE_ALWAYS_ASPECT recruitment_pattern "archer,fighter,scout,mixed fighter,mixed fighter,fighter"}
        [/ai]

        canrecruit=yes
        type=Gutwrencher Imp
        id=Dorghazaquiel
        name= _ "Dorghazaquiel"
        facing=se
        [modifications]
            {TRAIT_SLOW}
            {TRAIT_STRONG}
        [/modifications]
    [/side]

    [side]
        side=5
        team_name=evil
        user_team_name= _ "team_name^Dark Hive"
        {CHAOS_FLAG}

        recruit=Demon,Shaxthal Rayblade,Chaos Invoker,Chaos Headhunter
        {GOLD 170 190 210}

        {ai/aliases/stable_singleplayer.cfg}
        [ai]
            {AI_SIMPLE_ALWAYS_ASPECT recruitment_pattern "scout,mixed fighter,mixed fighter,archer,fighter,mixed fighter"}
        [/ai]

        canrecruit=yes
        type=Demon Warrior
        gender=female
        id=Elalanea
        name= _ "Elalanea"
        facing=sw
        [modifications]
            {TRAIT_INTELLIGENT}
            {TRAIT_RESILIENT}
        [/modifications]
    [/side]

    [side]
        side=6
        team_name=evil
        user_team_name= _ "team_name^Dark Hive"
        {CHAOS_FLAG}

        {ai/aliases/stable_singleplayer.cfg}
        [ai]
            {AI_SIMPLE_ALWAYS_ASPECT recruitment_pattern "scout,mixed fighter,mixed fighter,archer,fighter,mixed fighter"}
        [/ai]

        # Activated via event
        no_leader=yes
        hidden=yes
        {TB_NO_ECONOMY}
    [/side]

    #
    # Hive spawns
    #
    [side]
        side=7
        team_name=evil
        user_team_name= _ "team_name^Dark Hive"
        {CHAOS_FLAG}

        no_leader=yes
        hidden=yes
        {TB_NO_ECONOMY}

        {ai/aliases/stable_singleplayer.cfg}
        [ai]
            {TB_SHARED_AI_ASPECTS}
        [/ai]
    [/side]

    #
    # Hive worms
    #
    [side]
        side=8
        team_name=evil
        user_team_name= _ "team_name^Dark Hive"
        {CHAOS_FLAG}

        no_leader=yes
        hidden=yes
        {TB_NO_ECONOMY}

        {IS_HOSTILE_NPC}
    [/side]

    #
    # Door controller
    #
    [side]
        side=9
        team_name=evil
        user_team_name= _ "team_name^Dark Hive"
        {CHAOS_FLAG}
        color=black

        no_leader=yes
        hidden=yes
        {TB_NO_ECONOMY}
    [/side]

    #
    # Boss controller
    #
    [side]
        side=10
        controller=null
        team_name=evil
        user_team_name= _ "team_name^Dark Hive"
        {CHAOS_FLAG}
        color=yellow

        no_leader=yes
        hidden=yes
        {TB_NO_ECONOMY}
    [/side]

#undef TB_NO_ECONOMY
#undef TB_SHARED_AI_ASPECTS

    [event]
        name=prestart
        [remove_shroud]
            side=1
            x= 0-11,12-15
            y=17-30,22-28
            terrain=Qxu,Ur,Rrc
            [or]
                x= 9, 7,11,13, 9
                y=24,27,25,26,28
            [/or]
        [/remove_shroud]

        [hide_unit]
            id=Lady of Light
        [/hide_unit]

        {OBJECTIVES (
            {OBJECTIVE_VICTORY ( _ "Defeat the false Lady of Light")}

            {OBJECTIVE_DEFEAT  ( _ "Death of Elynia")}
            {OBJECTIVE_DEFEAT  ( _ "Death of Anya")}
            {OBJECTIVE_DEFEAT  ( _ "Death of Durvan")}

            {TURNS_RUN_OUT}
        )}

        [deactivate_and_serialize_sides]
            side=3,4,5
            variable=enemy_sides
        [/deactivate_and_serialize_sides]
    [/event]

    [event]
        name=start
        {MOVE_UNIT (id=Elynia) 13 28}

        [redraw]
            # clear shroud
            side=1
        [/redraw]

        {RECALL_ANYA_AT_LOCATION   13 27}
        {RECALL_DURVAN_AT_LOCATION 11 28}

        {MODIFY_UNIT (side=1) facing se}

        [redraw][/redraw]

        [delay]
            time=500
        [/delay]

        [message]
            speaker=Anya
            message= _ "Another gate..."
        [/message]

        [unit]
            x,y=14,28
            side=9
            type=Door
            upkeep=free
            max_hitpoints=8
        [/unit]

        [animate_attack]
            [filter]
                x,y=14,28
            [/filter]
            [filter_second]
                id=Elynia
            [/filter_second]
            [filter_attack]
                name=staff
            [/filter_attack]
            kill=yes
            animate=yes
            fire_event=no
            amount=8
            #experience=no
        [/animate_attack]

        [remove_terrain_overlays]
            x=13,14,15
            y=29,28,28
        [/remove_terrain_overlays]

        [redraw]
            # clear shroud
            side=1
        [/redraw]

        {MOVE_UNIT (id=Elynia) 16 29}
        {MOVE_UNIT (id=Anya) 17 29}
        {MOVE_UNIT (id=Durvan) 14 29}

        [capture_village]
            side=1
            x=14,19
            y=29,30
        [/capture_village]

        [remove_shroud]
            side=1
            x,y=19,31
            radius=15
            [filter_radius]
                [not]
                    terrain=X*,*^X*,Q*,*^Z*
                [/not]
            [/filter_radius]
        [/remove_shroud]

        [redraw]
            # clear shroud
            side=1
        [/redraw]

        [delay]
            time=500
        [/delay]

        [message]
            speaker=Anya
            message= _ "Look! It’s the impostor again!"
        [/message]

        [unhide_unit]
            id=Lady of Light
        [/unhide_unit]

        [scroll_to_unit]
            id=Lady of Light
        [/scroll_to_unit]

        [delay]
            time=750
        [/delay]

        [message]
            speaker=Lady of Light
            message= _ "I have to destroy her... yes, I have to... I must not fail this time..."
        [/message]

        [delay]
            time=250
        [/delay]

        [message]
            speaker=Elynia
            message= _ "So here you are, traitor."
        [/message]

        [scroll_to_unit]
            id=Lady of Light
        [/scroll_to_unit]

        {MODIFY_UNIT (id=Lady of Light) facing nw}

        [delay]
            time=250
        [/delay]

        [message]
            speaker=Lady of Light
            message= _ "I AM NOT A TRAITOR! I’LL DESTROY YOU THIS TIME!"
        [/message]

        [message]
            speaker=Anya
            message= _ "She doesn’t even try to prove you wrong..."
        [/message]

        [message]
            speaker=Elynia
            message= _ "I have had enough of this — surround her and strike her down! Do not let her get away this time!"
        [/message]
    [/event]

    [event]
        name=last breath
        [filter]
            id=Lady of Light
        [/filter]

        [message]
            speaker=Lady of Light
            message= _ "No... Let me go!"
        [/message]

        # Stop any playing attack/defense animations
        [animate_unit]
            [filter]
                x,y=$x2,$y2
            [/filter]
            flag=standing
        [/animate_unit]

        [animate_unit]
            [filter]
                x,y=$x1,$y1
            [/filter]
            flag=standing
        [/animate_unit]

        {VARIABLE lolx $x1}
        {VARIABLE loly $y1}

        [message]
            speaker=Elynia
            message= _ "You and your accursed allies have conspired against our people and the Grand Council of the Northern Peoples, creating strife and destruction amongst them. Whoever you are, your evil deeds do not make you worthy of my mercy anymore. You no longer deserve a place amongst our kind."
        [/message]

        [message]
            speaker=Lady of Light
            message= _ "... Elynia... please..."
        [/message]

        [message]
            speaker=Elynia
            message= _ "Leave this world <b>now</b>, and never return again!"
        [/message]

        [scroll_to_unit]
            id=Lady of Light
        [/scroll_to_unit]

        {FLASH_RED (
            [animate_unit]
                [filter]
                    id=Lady of Light
                [/filter]
                flag=cutscene_burning
                with_bars=yes
            [/animate_unit]

            [transform_unit]
                id=Lady of Light
                transform_to=Shaxthal Infiltrator
            [/transform_unit]

            [modify_unit]
                [filter]
                    id=Lady of Light
                [/filter]
                hitpoints=1
                moves=0
                attacks_left=0
                id=Ivyel
                name= _ "Ivyel"
                [modifications]
                    {TRAIT_BIOMECHANICAL}
                    {TRAIT_RESILIENT}
                    {TRAIT_DEXTROUS}
                [/modifications]
            [/modify_unit]
        )}

        [scroll_to_unit]
            id=Ivyel
        [/scroll_to_unit]

        [delay]
            time=1000
        [/delay]

        [message]
            speaker=Elynia
            message= _ "(<i>confused</i>) What is this?"
        [/message]

        [delay]
            time=750
        [/delay]

        [message]
            speaker=Ivyel
            message= _ "... Please... don’t attack me..."
        [/message]

        [message]
            speaker=Elynia
            message= _ "But... how... how is this possible?"
        [/message]

        [kill]
            id=Ivyel
            animate=no
            fire_event=no
        [/kill]

        [move_unit_fake]
            x="$lolx|,24,27"
            y="$loly|,33,35"
            side=2
            type=Shaxthal Infiltrator
        [/move_unit_fake]

        [message]
            speaker=Elynia
            message= _ "This doesn’t make sense!"
        [/message]

        [delay]
            time=500
        [/delay]

        [message]
            speaker=narrator
            image=wesnoth-icon.png
            message= _ "(<i>cackling</i>)"
        [/message]

        [message]
            speaker=Elynia
            message= _ "Who is that?!"
        [/message]

        [delay]
            time=250
        [/delay]

        [message]
            speaker=narrator
            image=wesnoth-icon.png
            message= _ "(<i>more cackling</i>) <i>What do you think of our first true infiltrator? She was incredibly hard to build, and to perfect.</i>"
        [/message]

        [delay]
            time=250
        [/delay]

        [message]
            speaker=Elynia
            message= _ "(<i>visibly angered</i>) I know you... You are one of the members of the Iron Council, Mal Hekuba..."
        [/message]

        [store_direction]
            from_x,from_y=22,32
            [to]
                [filter]
                    id=Elynia
                [/filter]
            [/to]
        [/store_direction]

        [unit]
            {CHARACTER_STATS_MAL_HEKUBA}
            {IS_BOSS}
            side=10
            x,y=22,32
            facing=$direction
        [/unit]

        [message]
            speaker=Mal Hekuba
            message= _ "Did you miss me, Elynia?"
        [/message]

#define TB_FIX_ELYNIA_FACING
        [store_direction]
            [from]
                [filter]
                    id=Elynia
                [/filter]
            [/from]
            [to]
                [filter]
                    id=Mal Hekuba
                [/filter]
            [/to]
        [/store_direction]

        {MODIFY_UNIT (id=Elynia) facing $direction}
#enddef

        {TB_FIX_ELYNIA_FACING}

        [delay]
            time=250
        [/delay]

        [message]
            speaker=Elynia
            message= _ "... I couldn’t possibly wish harder for you and your friends’ destruction."
        [/message]

        [message]
            speaker=Mal Hekuba
            message= _ "Ha, ha, but that’s not going to happen in your lifetime, or is it?"
        [/message]

#define TB_BOSS_TELEHIDE
        [scroll_to_unit]
            id=Mal Hekuba
        [/scroll_to_unit]

        [animate_unit]
            [filter]
                id=Mal Hekuba
            [/filter]
            flag=pre_teleport
            with_bars=yes
        [/animate_unit]

        [store_unit]
            [filter]
                id=Mal Hekuba
            [/filter]
            kill=yes
            variable=boss_store
        [/store_unit]
#enddef

#define TB_BOSS_TELESHOW _X _Y
        [scroll_to]
            x={_X}
            y={_Y}
        [/scroll_to]

        {VARIABLE boss_store.x ({_X})}
        {VARIABLE boss_store.y ({_Y})}

        [store_direction]
            from_x,from_y=$boss_store.x,$boss_store.y
            [to]
                [filter]
                    id=Elynia
                [/filter]
            [/to]
            variable=boss_store.facing
        [/store_direction]

        [unstore_unit]
            variable=boss_store
            find_vacant=yes
        [/unstore_unit]

        [animate_unit]
            [filter]
                id=Mal Hekuba
            [/filter]
            flag=post_teleport
            with_bars=yes
        [/animate_unit]
#enddef

        {TB_BOSS_TELEHIDE}

        # TODO: move Elynia around as if she were searching for Hekuba

        [delay]
            time=250
        [/delay]

        [message]
            speaker=Elynia
            message= _ "Where are you? Stop fooling around and show yourself, you—"
        [/message]

        {TB_BOSS_TELESHOW 14 32}

        [message]
            speaker=Mal Hekuba
            message= _ "I understand that you must be confused and angry after losing your friends to such a pointless cause and traveling from so far away slaughtering the same people whom you swore to protect eons ago!"
        [/message]

        {TB_FIX_ELYNIA_FACING}

        # TODO: move Elynia around, trying to attack Hekuba

        {TB_BOSS_TELEHIDE}

        [delay]
            time=250
        [/delay]

        [message]
            speaker=Elynia
            message= _ "Destroying you is NOT a pointless cause!"
        [/message]

#define TB_VOICE _MESSAGE
    [message]
        speaker=narrator
        caption= _ "Mal Hekuba"
        image=wesnoth-icon.png
        message="<i>"+{_MESSAGE}+"</i>"
    [/message]
#enddef

        {TB_VOICE ( _ "But of course it is! You cannot destroy us! Not without the power of the Union, anyway, which you left behind in Uria’s sacred domain when you destroyed your beloved Argan.")}

        [message]
            speaker=Elynia
            message= _ "I still have the Ruby of Fire!"
        [/message]

        {TB_VOICE ( _ "That understandably attractive relic is not important for <i>me</i>. Argan’s treacherous little girl likes to think of it as if it were unique and irreplaceable, but in truth, it is not.")}

        [delay]
            time=750
        [/delay]

        [message]
            speaker=Elynia
            message= _ "What are you babbling about?"
        [/message]

        {TB_VOICE ( _ "Yechnagoth’s heart replicas were lost when you and your pathetic lackey destroyed our base in Wesmere, but I have had plenty of time to create more here without her being able to know about them. I am sure that together, they are as good or better than the original, and they might even be a superior substitute for your precious gem.")}

        [delay]
            time=500
        [/delay]

        [message]
            speaker=Elynia
            message= _ "Are you working against Uria’s will, then?"
        [/message]

        [store_locations]
            [filter]
                id=Elynia
            [/filter]
            variable=elynia_loc
        [/store_locations]

        {TB_BOSS_TELESHOW $elynia_loc.x $elynia_loc.y}

        {CLEAR_VARIABLE elynia_loc}

        {TB_FIX_ELYNIA_FACING}

        [message]
            speaker=Mal Hekuba
            message= _ "(<i>losing his temper</i>) We cannot speak to her directly! We can only do so through that treacherous wench, who keeps the original heart within her for her own purposes!"
        [/message]

        {TB_BOSS_TELEHIDE}

        [delay]
            time=1000
        [/delay]

        [message]
            speaker=Elynia
            message= _ "... We... We destroyed Wesmere... Yechnagoth’s heart wasn’t there?! What did we shatter when we..."
        [/message]

        {TB_VOICE ( _ "The energy that should have destroyed you was released from the shattered remains of the <i>second</i> replica of her heart’s core, and various experimental units. The third one powers our infiltrator, who just failed to defeat. And of course, you cannot defeat her, for her power goes far beyond yours — she is, after all, an imitation of Yechnagoth’s grace and might.")}

        {TB_VOICE ( _ "Nevertheless, I do not have much more time to talk to you. I need to go to tend to some... rituals. Ivyel was created to destroy you and our own traitor. Take a good glance at her perfection, for it will be your last.")}

        [message]
            speaker=narrator
            image=wesnoth-icon.png
            message= _ "(<i>more cackling</i>)"
        [/message]

#undef TB_VOICE
#undef TB_BOSS_TELEHIDE
#undef TB_BOSS_TELESHOW
#undef TB_FIX_ELYNIA_FACING

        [unserialize_and_activate_sides]
            variable=enemy_sides
        [/unserialize_and_activate_sides]

        {CLEAR_VARIABLE direction,boss_store,enemy_sides}
    [/event]

    [event]
        name=moveto
        first_time_only=no
        [filter]
            type=Vampire Bat
            side=1
        [/filter]
        [filter_condition]
            [have_unit]
                type=Ancient Wose
            [/have_unit]
        [/filter_condition]

        [store_locations]
            [filter]
                type=Ancient Wose
            [/filter]
            variable=origin
        [/store_locations]

        [store_direction]
            from_x=$origin.x
            from_y=$origin.y
            to_x=$x1
            to_y=$y1
        [/store_direction]

        [message]
            speaker=narrator
            message="The bat is at $direction of the wose."
        [/message]
    [/event]
[/scenario]

# kate: indent-mode normal; encoding utf-8; space-indent on;
