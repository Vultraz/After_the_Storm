#textdomain wesnoth-After_the_Storm

[scenario]
    id=10_The_Betrayal
    name= _ "The Betrayal"
    {MAP 10_The_Betrayal.map}
    {TURNS 6 5 4}
    next_scenario=11_A_Final_Confrontation
    victory_when_enemies_defeated=no

    {END_OF_PLAYABLE_SCENARIOS}

    {E_DEATHS}

    {SCENARIO_MUSIC       "breaking_the_chains.ogg"} {CONTINUE_PLAYING_STORY_MUSIC_FIRST}
    {EXTRA_SCENARIO_MUSIC "legends_of_the_north.ogg"}

    {STORYTXT_THE_BETRAYAL}

    {INDOORS_HIVE}

#define TB_NO_ECONOMY
    gold,village_gold=0,0
    {NO_INCOME}
#enddef

#define TB_SHARED_AI_ASPECTS
    {AI_SIMPLE_ALWAYS_ASPECT aggression 5.00}
    {AI_SIMPLE_ALWAYS_ASPECT caution    0.00}
    {AI_SIMPLE_ALWAYS_ASPECT grouping     no}
#enddef

    {SPAWN_CONTROLLER}

    # wmllint: validate-off
    [side]
        side=1
        controller=human
        save_id=player
        team_name=good
        user_team_name= _ "team_name^Elynia"

        {GOLD 140 120 100}
        {INCOME 3 2 2}

        shroud=yes

        {CHARACTER_STATS_ELYNIA}
    [/side]
    # wmllint: validate-on

    [side]
        side=2
        team_name=evil
        user_team_name= _ "team_name^Dark Hive"
        {CHAOS_FLAG}

        recruit=Shaxthal Drone,Automaton,Chaos Hound
        {GOLD 75 80 95}

        {ai/aliases/stable_singleplayer.cfg}
        [ai]
            {AI_SIMPLE_ALWAYS_ASPECT aggression 5.00}
            {AI_SIMPLE_ALWAYS_ASPECT caution    0.00}
            {AI_SIMPLE_ALWAYS_ASPECT attack_depth {DIFF 2 3 4} }
            {AI_SIMPLE_ALWAYS_ASPECT recruitment_pattern "fighter,mixed fighter,mixed fighter,fighter,scout"}
        [/ai]

        canrecruit=yes
        type=Faerie Avatar
        id=Lady of Light
        name= _ "Lady of Light"
        #profile="portraits/ivyel.png"
        facing=se
        [modifications]
            {TRAIT_RESILIENT}
            {TRAIT_DEXTROUS}
        [/modifications]

        [village]
            x,y=24,32
        [/village]
        [village]
            x,y=19,32
        [/village]
    [/side]

    [side]
        side=3
        team_name=evil
        user_team_name= _ "team_name^Dark Hive"
        {CHAOS_FLAG}

        recruit=Chaos Invader,Chaos Invoker,Chaos Headhunter,Shaxthal Runner Drone
        {GOLD 120 130 150}

        {ai/aliases/stable_singleplayer.cfg}
        [ai]
            {AI_SIMPLE_ALWAYS_ASPECT aggression           1.00}
            {AI_SIMPLE_ALWAYS_ASPECT caution              0.00}
            {AI_SIMPLE_ALWAYS_ASPECT attack_depth         {DIFF 3 4 5} }
            {AI_SIMPLE_ALWAYS_ASPECT recruitment_pattern "archer,scout,scout,fighter,mixed fighter,archer"}
        [/ai]

        canrecruit=yes
        type=Hell Guardian
        id=Stalygvan
        name= _ "Stalygvan"
        facing=nw
        [modifications]
            {TRAIT_STRONG}
            {TRAIT_RESILIENT}
        [/modifications]
    [/side]

    [side]
        side=4
        team_name=evil
        user_team_name= _ "team_name^Dark Hive"
        {CHAOS_FLAG}

        recruit=Shaxthal Drone,Automaton,Chaos Headhunter,Chaos Bowman
        {GOLD 150 170 190}

        {ai/aliases/stable_singleplayer.cfg}
        [ai]
            {AI_SIMPLE_ALWAYS_ASPECT attack_depth         {DIFF 2 3 4} }
            {AI_SIMPLE_ALWAYS_ASPECT recruitment_pattern "archer,fighter,scout,mixed fighter,mixed fighter,fighter"}
        [/ai]

        canrecruit=yes
        type=Gutwrencher Imp
        id=Dorghazaquiel
        name= _ "Dorghazaquiel"
        facing=se
        [modifications]
            {TRAIT_SLOW}
            {TRAIT_STRONG}
        [/modifications]
    [/side]

    [side]
        side=5
        team_name=evil
        user_team_name= _ "team_name^Dark Hive"
        {CHAOS_FLAG}

        recruit=Demon,Shaxthal Rayblade,Chaos Invoker,Chaos Headhunter
        {GOLD 170 190 210}

        {ai/aliases/stable_singleplayer.cfg}
        [ai]
            {AI_SIMPLE_ALWAYS_ASPECT recruitment_pattern "scout,mixed fighter,mixed fighter,archer,fighter,mixed fighter"}
        [/ai]

        canrecruit=yes
        type=Demon Warrior
        gender=female
        id=Elalanea
        name= _ "Elalanea"
        facing=sw
        [modifications]
            {TRAIT_INTELLIGENT}
            {TRAIT_RESILIENT}
        [/modifications]
    [/side]

    [side]
        side=6
        team_name=evil
        user_team_name= _ "team_name^Dark Hive"
        {CHAOS_FLAG}

        recruit=Demon,Automaton,Chaos Hound,Chaos Invoker
        {GOLD 200 220 240}

        {ai/aliases/stable_singleplayer.cfg}
        [ai]
            {AI_SIMPLE_ALWAYS_ASPECT attack_depth         {DIFF 2 3 4} }
            {AI_SIMPLE_ALWAYS_ASPECT recruitment_pattern "archer,fighter,mixed fighter,mixed fighter,scout,scout,fighter,archer,mixed fighter"}
        [/ai]

        canrecruit=yes
        type=Shaxthal Warlord
        id=Alareanthalcan
        name= _ "Alareanthalcan"
        facing=sw
        [modifications]
            {TRAIT_BIOMECHANICAL}
            {TRAIT_ARMORED}
        [/modifications]
    [/side]

    #
    # Hive spawns
    #
    [side]
        side=7
        team_name=evil
        user_team_name= _ "team_name^Dark Hive"
        {CHAOS_FLAG}

        no_leader=yes
        hidden=yes
        {TB_NO_ECONOMY}

        {ai/aliases/stable_singleplayer.cfg}
        [ai]
            {TB_SHARED_AI_ASPECTS}
        [/ai]
    [/side]

    #
    # Hive worms
    #
    [side]
        side=8
        team_name=evil
        user_team_name= _ "team_name^Dark Hive"
        {CHAOS_FLAG}

        no_leader=yes
        hidden=yes
        {TB_NO_ECONOMY}

        {IS_HOSTILE_NPC}
    [/side]

#define TB_DOOR _X _Y
    {GENERIC_UNIT () Door ({_X}) ({_Y})}
#enddef

    #
    # Door controller
    #
    [side]
        side=9
        team_name=evil
        user_team_name= _ "team_name^Dark Hive"
        {CHAOS_FLAG}
        color=black

        no_leader=yes
        hidden=yes
        {TB_NO_ECONOMY}

        {TB_DOOR 54 34}
        {TB_DOOR 63 46}
        {TB_DOOR 34 47}
        {TB_DOOR 11 48}
        {TB_DOOR 12 47}
    [/side]

#undef TB_DOOR

    #
    # Boss controller
    #
    [side]
        side=10
        controller=null
        team_name=evil
        user_team_name= _ "team_name^Dark Hive"
        {CHAOS_FLAG}
        color=yellow

        no_leader=yes
        hidden=yes
        {TB_NO_ECONOMY}
    [/side]

#undef TB_NO_ECONOMY
#undef TB_SHARED_AI_ASPECTS

#define TB_CAPTURE_STARTING_VILLAGES _SIDE _RADIUS
    [store_starting_location]
        variable=temp_TB_CAPTURE_STARTING_VILLAGES
    [/store_starting_location]

    {CAPTURE_VILLAGES_OF_TYPE (*^V*) {_SIDE} $temp_TB_CAPTURE_STARTING_VILLAGES.x $temp_TB_CAPTURE_STARTING_VILLAGES.y {_RADIUS}}

    {CLEAR_VARIABLE temp_TB_CAPTURE_STARTING_VILLAGES}
#enddef

    [event]
        name=prestart
        [remove_shroud]
            side=1
            x= 0-11,12-15
            y=17-30,22-28
            terrain=Qxu,Ur,Rrc
            [or]
                x= 9, 7,11,13, 9
                y=24,27,25,26,28
            [/or]
        [/remove_shroud]

        [hide_unit]
            id=Lady of Light
        [/hide_unit]

        {OBJECTIVES (
            {OBJECTIVE_VICTORY ( _ "Defeat the false Lady of Light")}

            {OBJECTIVE_DEFEAT  ( _ "Death of Elynia")}
            {OBJECTIVE_DEFEAT  ( _ "Death of Anya")}
            {OBJECTIVE_DEFEAT  ( _ "Death of Durvan")}

            {TURNS_RUN_OUT}
        )}

        [deactivate_and_serialize_sides]
            side=3,4,5
            variable=enemy_sides
        [/deactivate_and_serialize_sides]

        [deactivate_and_serialize_sides]
            side=6
            variable=late_enemy_side
        [/deactivate_and_serialize_sides]
    [/event]

    [event]
        name=start
        {MOVE_UNIT (id=Elynia) 13 28}

        [redraw]
            # clear shroud
            side=1
        [/redraw]

        {RECALL_ANYA_AT_LOCATION   13 27}
        {RECALL_DURVAN_AT_LOCATION 11 28}

        {MODIFY_UNIT (side=1) facing se}

        [redraw][/redraw]

        [delay]
            time=500
        [/delay]

        [message]
            speaker=Anya
            message= _ "Another gate..."
        [/message]

        [unit]
            x,y=14,28
            side=9
            type=Door
            upkeep=free
            max_hitpoints=8
        [/unit]

        [animate_attack]
            [filter]
                x,y=14,28
            [/filter]
            [filter_second]
                id=Elynia
            [/filter_second]
            [filter_attack]
                name=staff
            [/filter_attack]
            kill=yes
            animate=yes
            fire_event=no
            amount=8
            #experience=no
        [/animate_attack]

        [remove_terrain_overlays]
            x=13,14,15
            y=29,28,28
        [/remove_terrain_overlays]

        [redraw]
            # clear shroud
            side=1
        [/redraw]

        {MOVE_UNIT (id=Elynia) 16 29}
        {MOVE_UNIT (id=Anya) 17 29}
        {MOVE_UNIT (id=Durvan) 14 29}

        [capture_village]
            side=1
            x=14,19
            y=29,30
        [/capture_village]

        [remove_shroud]
            side=1
            x,y=19,31
            radius=15
            [filter_radius]
                [not]
                    terrain=X*,*^X*,Q*,*^Z*
                [/not]
            [/filter_radius]
        [/remove_shroud]

        [redraw]
            # clear shroud
            side=1
        [/redraw]

        [delay]
            time=500
        [/delay]

        [message]
            speaker=Anya
            message= _ "Look! Itâ€™s the impostor again!"
        [/message]

        [unhide_unit]
            id=Lady of Light
        [/unhide_unit]

        [scroll_to_unit]
            id=Lady of Light
        [/scroll_to_unit]

        [delay]
            time=750
        [/delay]

        [message]
            speaker=Lady of Light
            message= _ "I have to destroy her... yes, I have to... I must not fail this time..."
        [/message]

        [delay]
            time=250
        [/delay]

        [message]
            speaker=Elynia
            message= _ "So here you are, traitor."
        [/message]

        [scroll_to_unit]
            id=Lady of Light
        [/scroll_to_unit]

        {MODIFY_UNIT (id=Lady of Light) facing nw}

        [delay]
            time=250
        [/delay]

        [message]
            speaker=Lady of Light
            message= _ "I AM NOT A TRAITOR! Iâ€™LL DESTROY YOU THIS TIME!"
        [/message]

        [message]
            speaker=Anya
            message= _ "She doesnâ€™t even try to prove you wrong..."
        [/message]

        [message]
            speaker=Elynia
            message= _ "I have had enough of this â€” surround her and strike her down! Do not let her get away this time!"
        [/message]

        [terrain]
            x=13,14,15
            y=29,28,28
            terrain=Uu^Xo
            layer=overlay
        [/terrain]

        [redraw][/redraw]
    [/event]

    [event]
        name=last breath
        [filter]
            id=Lady of Light
        [/filter]

        [message]
            speaker=Lady of Light
            message= _ "No... Let me go!"
        [/message]

        # Stop any playing attack/defense animations
        [animate_unit]
            [filter]
                x,y=$x2,$y2
            [/filter]
            flag=standing
        [/animate_unit]

        [animate_unit]
            [filter]
                x,y=$x1,$y1
            [/filter]
            flag=standing
        [/animate_unit]

        {VARIABLE lolx $x1}
        {VARIABLE loly $y1}

        [message]
            speaker=Elynia
            message= _ "You and your accursed allies have conspired against our people and the Grand Council of the Northern Peoples, creating strife and destruction amongst them. Whoever you are, your evil deeds do not make you worthy of my mercy anymore. You no longer deserve a place amongst our kind."
        [/message]

        [message]
            speaker=Lady of Light
            message= _ "... Elynia... please..."
        [/message]

        [message]
            speaker=Elynia
            message= _ "Leave this world <b>now</b>, and never return again!"
        [/message]

        [scroll_to_unit]
            id=Lady of Light
        [/scroll_to_unit]

        {FLASH_RED (
            [animate_unit]
                [filter]
                    id=Lady of Light
                [/filter]
                flag=cutscene_burning
                with_bars=yes
            [/animate_unit]

            [transform_unit]
                id=Lady of Light
                transform_to=Shaxthal Infiltrator
            [/transform_unit]

            [modify_unit]
                [filter]
                    id=Lady of Light
                [/filter]
                hitpoints=1
                moves=0
                attacks_left=0
                id=Ivyel
                name= _ "Ivyel"
                [modifications]
                    {TRAIT_BIOMECHANICAL}
                    {TRAIT_RESILIENT}
                    {TRAIT_DEXTROUS}
                [/modifications]
            [/modify_unit]
        )}

        [scroll_to_unit]
            id=Ivyel
        [/scroll_to_unit]

        [delay]
            time=1000
        [/delay]

        [message]
            speaker=Elynia
            message= _ "(<i>confused</i>) What is this?"
        [/message]

        [delay]
            time=750
        [/delay]

        [message]
            speaker=Ivyel
            message= _ "... Please... donâ€™t attack me..."
        [/message]

        [message]
            speaker=Elynia
            message= _ "But... how... how is this possible?"
        [/message]

        [kill]
            id=Ivyel
            animate=no
            fire_event=no
        [/kill]

        [move_unit_fake]
            x="$lolx|,24,27"
            y="$loly|,33,35"
            side=2
            type=Shaxthal Infiltrator
        [/move_unit_fake]

        [message]
            speaker=Elynia
            message= _ "This doesnâ€™t make sense!"
        [/message]

        [delay]
            time=500
        [/delay]

        [message]
            speaker=narrator
            image=wesnoth-icon.png
            message= _ "(<i>cackling</i>)"
        [/message]

        [message]
            speaker=Elynia
            message= _ "Who is that?!"
        [/message]

        [delay]
            time=250
        [/delay]

        [message]
            speaker=narrator
            image=wesnoth-icon.png
            message= _ "(<i>more cackling</i>) <i>What do you think of our first true infiltrator? She was incredibly hard to build, and to perfect.</i>"
        [/message]

        [delay]
            time=250
        [/delay]

        [message]
            speaker=Elynia
            message= _ "(<i>visibly angered</i>) I know you... You are one of the members of the Iron Council, Mal Hekuba..."
        [/message]

        [store_direction]
            from_x,from_y=22,32
            [to]
                [filter]
                    id=Elynia
                [/filter]
            [/to]
        [/store_direction]

        [unit]
            {CHARACTER_STATS_MAL_HEKUBA}
            {IS_BOSS}
            side=10
            x,y=22,32
            facing=$direction
        [/unit]

        [message]
            speaker=Mal Hekuba
            message= _ "Did you miss me, Elynia?"
        [/message]

#define TB_FIX_ELYNIA_FACING
        [store_direction]
            [from]
                [filter]
                    id=Elynia
                [/filter]
            [/from]
            [to]
                [filter]
                    id=Mal Hekuba
                [/filter]
            [/to]
        [/store_direction]

        {MODIFY_UNIT (id=Elynia) facing $direction}
#enddef

        {TB_FIX_ELYNIA_FACING}

        [delay]
            time=250
        [/delay]

        [message]
            speaker=Elynia
            message= _ "... I couldnâ€™t possibly wish harder for you and your friendsâ€™ destruction."
        [/message]

        [message]
            speaker=Mal Hekuba
            message= _ "Ha, ha, but thatâ€™s not going to happen in your lifetime, or is it?"
        [/message]

#define TB_BOSS_TELEHIDE
        [scroll_to_unit]
            id=Mal Hekuba
        [/scroll_to_unit]

        [animate_unit]
            [filter]
                id=Mal Hekuba
            [/filter]
            flag=pre_teleport
            with_bars=yes
        [/animate_unit]

        [store_unit]
            [filter]
                id=Mal Hekuba
            [/filter]
            kill=yes
            variable=boss_store
        [/store_unit]
#enddef

#define TB_BOSS_TELESHOW _X _Y
        [scroll_to]
            x={_X}
            y={_Y}
        [/scroll_to]

        {VARIABLE boss_store.x ({_X})}
        {VARIABLE boss_store.y ({_Y})}

        [store_direction]
            from_x,from_y=$boss_store.x,$boss_store.y
            [to]
                [filter]
                    id=Elynia
                [/filter]
            [/to]
            variable=boss_store.facing
        [/store_direction]

        [unstore_unit]
            variable=boss_store
            find_vacant=yes
        [/unstore_unit]

        [animate_unit]
            [filter]
                id=Mal Hekuba
            [/filter]
            flag=post_teleport
            with_bars=yes
        [/animate_unit]
#enddef

        {TB_BOSS_TELEHIDE}

        # TODO: move Elynia around as if she were searching for Hekuba

        [delay]
            time=250
        [/delay]

        [message]
            speaker=Elynia
            message= _ "Where are you? Stop fooling around and show yourself, youâ€”"
        [/message]

        {TB_BOSS_TELESHOW 14 32}

        [message]
            speaker=Mal Hekuba
            message= _ "I understand that you must be confused and angry after losing your friends to such a pointless cause and traveling from so far away slaughtering the same people whom you swore to protect eons ago!"
        [/message]

        {TB_FIX_ELYNIA_FACING}

        # TODO: move Elynia around, trying to attack Hekuba

        {TB_BOSS_TELEHIDE}

        [delay]
            time=250
        [/delay]

        [message]
            speaker=Elynia
            message= _ "Destroying you is NOT a pointless cause!"
        [/message]

#define TB_VOICE _MESSAGE
    [message]
        speaker=narrator
        caption= _ "Mal Hekuba"
        image=wesnoth-icon.png
        message="<i>"+{_MESSAGE}+"</i>"
    [/message]
#enddef

        {TB_VOICE ( _ "But of course it is! You cannot destroy us! Not without the power of the Union, anyway, which you left behind in Uriaâ€™s sacred domain when you destroyed your beloved Argan.")}

        [message]
            speaker=Elynia
            message= _ "I still have the Ruby of Fire!"
        [/message]

        {TB_VOICE ( _ "That understandably attractive relic is not important for <i>me</i>. Arganâ€™s treacherous little girl likes to think of it as if it were unique and irreplaceable, and convinced Uria of that â€” but in truth, it is not.")}

        [delay]
            time=750
        [/delay]

        [message]
            speaker=Elynia
            message= _ "What are you babbling about?"
        [/message]

        {TB_VOICE ( _ "Yechnagothâ€™s heart replicas were lost when you and your pathetic lackey destroyed our base in Wesmere, but I have had plenty of time to create more here without her being able to know about them. I am sure that together, they are as good or better than the original, and they might even be a superior substitute for your precious gem.")}

        [delay]
            time=500
        [/delay]

        [message]
            speaker=Elynia
            message= _ "Are you working against Uriaâ€™s will, then?"
        [/message]

        [store_locations]
            [filter]
                id=Elynia
            [/filter]
            variable=elynia_loc
        [/store_locations]

        {TB_BOSS_TELESHOW $elynia_loc.x $elynia_loc.y}

        {CLEAR_VARIABLE elynia_loc}

        {TB_FIX_ELYNIA_FACING}

        [message]
            speaker=Mal Hekuba
            message= _ "(<i>losing his temper</i>) We cannot speak to her directly! We can only do so through that treacherous wench, who keeps the original heart within her for her own purposes!"
        [/message]

        {TB_BOSS_TELEHIDE}

        [delay]
            time=1000
        [/delay]

        [message]
            speaker=Elynia
            message= _ "... We... We destroyed Wesmere... Yechnagothâ€™s heart wasnâ€™t there?! What did we shatter when we..."
        [/message]

        {TB_VOICE ( _ "The energy that should have destroyed you was released from the shattered remains of the <i>second</i> replica of her heartâ€™s core, and various experimental units. The third one powers our infiltrator, who just failed to defeat. And of course, you cannot defeat her, for her power goes far beyond yours â€” she is, after all, an imitation of Yechnagothâ€™s grace and might.")}

        {TB_VOICE ( _ "Nevertheless, I do not have much more time to talk to you. I need to go to tend to some... rituals. Ivyel was created to destroy you and our own traitor. Take a good glance at her perfection, for it will be your last.")}

        [message]
            speaker=narrator
            image=wesnoth-icon.png
            message= _ "(<i>more cackling</i>)"
        [/message]

#undef TB_VOICE
#undef TB_BOSS_TELEHIDE
#undef TB_BOSS_TELESHOW
#undef TB_FIX_ELYNIA_FACING

        [redraw][/redraw]

        [delay]
            time=1000
        [/delay]

        [message]
            speaker=Anya
            message= _ "What are we going to do now?"
        [/message]

        [message]
            speaker=Durvan
            message= _ "Those bastards canâ€™t get away with this! My lady, we must do something!"
        [/message]

        [delay]
            time=500
        [/delay]

        [message]
            speaker=Elynia
            message= _ "I donâ€™t think we have the power necessary to destroy the artifacts that Mal Hekuba is going to use to..."
        [/message]

        [message]
            speaker=Anya
            message= _ "Of course we do! We didnâ€™t come all the way from the northern lands risking that blasted Ruby! Whatever that lich is going to do, it will destroy us all if we donâ€™t stop him now!"
        [/message]

        [message]
            speaker=Elynia
            message= _ "The last time we fought against that power, I lost a friend, and the vast plains of Wesmere vanished with his remains..."
        [/message]

        [message]
            speaker=Anya
            message= _ "Any course of action at this point will inevitably lead to someoneâ€™s destruction, but Iâ€™m sure we can do it this time! If the lich is going to create a... path to Inferno, as Elorran said, perhaps we can cause it to collapse at the other side!"
        [/message]

        [message]
            speaker=Durvan
            message= _ "But weâ€™ll need to destroy the lich first. We canâ€™t do that without your help, Elynia."
        [/message]

        [message]
            speaker=Anya
            message= _ "We donâ€™t have much time! That thing we just fought could be back in any moment!"
        [/message]

        [delay]
            time=750
        [/delay]

        [message]
            speaker=Elynia
            message= _ "I appreciate your support... I donâ€™t think I could have come this far alone. And I donâ€™t want to force you to follow me..."
        [/message]

        [message]
            speaker=Anya
            message= _ "Of course not! We are your friends!"
        [/message]

        [message]
            speaker=Elynia
            message= _ "Letâ€™s find that foul fiend and destroy him once and for all."
        [/message]

        {OBJECTIVES (
            {OBJECTIVE_VICTORY ( _ "Proceed further underground with Elynia to find Mal Hekuba")}

            {OBJECTIVE_DEFEAT  ( _ "Death of Elynia")}
            {OBJECTIVE_DEFEAT  ( _ "Death of Anya")}
            {OBJECTIVE_DEFEAT  ( _ "Death of Durvan")}

            {TURNS_RUN_OUT}
        )}

        [fire_event]
            name=activate enemy sides
        [/fire_event]

#define TB_GATE_LOCS
    x=23,24,25
    y=34,33,33
#enddef

        [remove_terrain_overlays]
            {TB_GATE_LOCS}
        [/remove_terrain_overlays]

        [remove_shroud]
            side=1
            {TB_GATE_LOCS}
        [/remove_shroud]

        [redraw]
            side=1
        [/redraw]

        [scroll_to]
            x,y=24,33
        [/scroll_to]

        {REPEAT 3 (
            [item]
                {TB_GATE_LOCS}
                image="misc/goal-highlight.png"
            [/item]

            [redraw][/redraw]

            [delay]
                time=300
            [/delay]

            [remove_item]
                {TB_GATE_LOCS}
            [/remove_item]

            [redraw][/redraw]

            [delay]
                time=300
            [/delay]
        )}

#undef TB_GATE_LOCS

        [scroll_to_unit]
            id=Elynia
        [/scroll_to_unit]

        [redraw][/redraw]

        {CLEAR_VARIABLE direction,boss_store,lolx,loly}
    [/event]

    [event]
        name=activate enemy sides

        [unserialize_and_activate_sides]
            variable=enemy_sides
        [/unserialize_and_activate_sides]

        {CLEAR_VARIABLE enemy_sides}

        {TB_CAPTURE_STARTING_VILLAGES 3 12}

        {TB_CAPTURE_STARTING_VILLAGES 4 6}

        {TB_CAPTURE_STARTING_VILLAGES 5 12}

        [redraw][/redraw]
    [/event]

    [event]
        name=moveto
        [filter]
            side=1
            x=32-67
            y=20-32
        [/filter]

        [fire_event]
            name=activate late enemy side
        [/fire_event]
    [/event]

    [event]
        name=activate late enemy side

        [unserialize_and_activate_sides]
            variable=late_enemy_side
        [/unserialize_and_activate_sides]

        {CLEAR_VARIABLE late_enemy_side}

        {TB_CAPTURE_STARTING_VILLAGES 9}

        [redraw][/redraw]

        [allow_undo][/allow_undo]
    [/event]

    {GATE_GLYPH 65 47 39 35}

    {GATE_GLYPH  6 35 41 34}

    {GATE_GLYPH 48 46 37 36}

    {GATE_GLYPH 38  2 35 15}

    {OBJ_HEALING_GLYPH 38 5}

    {OBJ_HEALING_GLYPH 35 4}

    {OBJ_HEALING_GLYPH 36 6}

    {OBJ_HEALING_GLYPH 41 3}

    # FIXME: placeholder for 53,33 until I figure out something more
    # interesting to put in there.
    {OBJ_HEALING_GLYPH 53 33}

    [event]
        name=last breath
        [filter]
            id=Stalygvan
        [/filter]

        [message]
            speaker=Stalygvan
            message= _ "You! You canâ€™t stop our master! You canâ€™tâ€”"
        [/message]
    [/event]

    [event]
        name=die
        [filter]
            id=Stalygvan
        [/filter]

        {UNIT 1 (Elvish Fighter) 35 39 (
            id=Kardas
            name= _ "Kardas"
            unrenamable=yes
            upkeep=free
            {IS_LOYAL}
            [modifications]
                {TRAIT_LOYAL}
                {TRAIT_INTELLIGENT}
            [/modifications]
        )}

        {MOVE_UNIT (id=Kardas) 35,36,36 39,39,40}

        [message]
            speaker=Kardas
            message= _ "My lady! At last, I found you! I know where the lich is!"
        [/message]

        [message]
            speaker=Elynia
            message= _ "Speak."
        [/message]

        [remove_shroud]
            side=1
            x=35,35,36,36,36,37,37,37,37,38,38,38,38,38,39,39,39,39,39,39,40,40,40,40,41,41,41,42,42,43
            y=35,36,34,35,36,34,35,36,37,33,34,35,36,37,33,34,35,36,37,38,33,34,35,36,34,35,36,34,35,35
        [/remove_shroud]

        [redraw]
            side=1
        [/redraw]

        [scroll_to]
            x,y=39,35
        [/scroll_to]

        [delay]
            time=250
        [/delay]

        [message]
            speaker=Kardas
            message= _ "The catacombs below guard an artifact of some sort. Nobody knows exactly what it is, but we know the entrance is protected by a gate controlled by three crystals found near this guard post."
        [/message]

        [simplify_location_filter]
            x=33-44
            y=31-38
            terrain="*^Zz\,*^Zz/"
            variable=glyph_gate_locs
        [/simplify_location_filter]

        {REPEAT 3 (
            [remove_terrain_overlays]
                x=$glyph_gate_locs.x
                y=$glyph_gate_locs.y
            [/remove_terrain_overlays]

            [redraw][/redraw]

            [delay]
                time=300
            [/delay]

            [terrain]
                x=$glyph_gate_locs.x
                y=$glyph_gate_locs.y
                terrain="Uu^Zz\"
                layer=overlay
            [/terrain]

            [redraw][/redraw]

            [delay]
                time=300
            [/delay]
        )}

        [message]
            speaker=Elynia
            message= _ "Letâ€™s find those crystals, then."
        [/message]
    [/event]

[/scenario]

# kate: indent-mode normal; encoding utf-8; space-indent on;
