#textdomain wesnoth-After_the_Storm

[scenario]
    id=01_Beyond_her_Smile
    name= _ "Beyond her Smile"
    {MAP 01_1_Beyond_her_Smile.map}
    turns=-1
    next_scenario=02_The_Fall_of_Raelthyn
    victory_when_enemies_defeated=no # FIXME: remove after testing

    {END_OF_PLAYABLE_SCENARIOS}

    {SCENARIO_MUSIC "knolls.ogg"}

    {STORYTXT_BEYOND_HER_SMILE}

    {LONGDARK4}
    {DAWN1}
    {MORNING1}
    {MIDDAY1}
    {AFTERNOON1}
    {DUSK1}
    {SHORTDARK}
    {DAWN2}
    {MORNING2}
    {MIDDAY2}
    {AFTERNOON2}
    {DUSK2}
    {LONGDARK1}
    {LONGDARK3}
    {LONGDARK2}

    {SHAXTHAL_SET_SURFACE_VARIATIONS_FLAG}

#define BHS_NO_ECONOMY
    gold=0
    {NO_INCOME}
    village_gold=0
#enddef

    # wmllint: validate-off
    [side]
        side=1
        controller=human
        save_id=player
        {BHS_NO_ECONOMY}
        team_name=good
        user_team_name= _ "team_name^Elynia"

        # Prevent map snapshot for start-of-scenario saved game.
        shroud=yes

        # wmllint: recognize Elynia
        {CHARACTER_STATS_ELYNIA}
        facing=ne
    [/side]
    # wmllint: validate-on

    [side]
        side=2
        team_name=good
        user_team_name= _ "team_name^Elorran"

        no_leader=yes
        hidden=yes

        {BHS_NO_ECONOMY}
    [/side]

    [side]
        side=3
        team_name=evil
        user_team_name= _ "team_name^Uria"

        no_leader=yes
        hidden=yes

        recruit=Demon,Imp,Chaos Invoker,Chaos Headhunter
        {GOLD 180 210 230}
    [/side]

    [side]
        side=4
        team_name=evil
        user_team_name= _ "team_name^Uria"

        no_leader=yes
        hidden=yes

        recruit=Shaxthal Drone,Chaos Hound,Shaxthal Razorbird
        {GOLD 160 175 190}
    [/side]

    [side]
        side=5
        team_name=evil
        user_team_name= _ "team_name^Uria"

        no_leader=yes
        hidden=yes

        recruit=Shaxthal Runner Drone,Chaos Raider,Chaos Bowman,Chaos Invader
        {GOLD 160 180 200}
    [/side]

    [side]
        side=6
        controller=null
        team_name=door
        color=black

        no_leader=yes
        hidden=yes

        {BHS_NO_ECONOMY}
    [/side]

#undef BHS_NO_ECONOMY

#define BHS_UPDATE_PERSISTENTLY_STORED_UNIT _ID
[if]
    # Make sure the persistent variable was retrieved
    {VARIABLE_NUMERICAL_NOT_EQUALS persist_store.length 0}
    [then]
        [store_unit]
            [filter]
                id={_ID}
            [/filter]
            kill=yes
            variable=fix_unit_store
        [/store_unit]

        [set_variables]
            name="fix_unit_store"
            mode=merge
            [value]
                # Start with max HP
                hitpoints=$persist_store.max_hitpoints
                max_hitpoints=$persist_store.max_hitpoints
                # Start with previous XP
                experience=$persist_store.experience
                max_experience=$persist_store.max_experience
                # Start with max MP
                moves=$persist_store.max_moves
                max_moves=$persist_store.max_moves
            [/value]
        [/set_variables]

        [if]
            {VARIABLE_NUMERICAL_NOT_EQUALS persist_store.modifications.advance.length 0}
            [then]
                [set_variables]
                    name="fix_unit_store.modifications.advance"
                    mode=replace
                    to_variable="persist_store.modifications.advance"
                [/set_variables]
            [/then]
        [/if]

        {CLEAR_VARIABLE fix_unit_store.status}

        [unstore_unit]
            variable="fix_unit_store"
            find_vacant=yes
            advance=no
        [/unstore_unit]

        {CLEAR_VARIABLE fix_unit_store}
    [/then]
[/if]
#enddef

    [event]
        name=prestart

        [modify_side]
            side=1
            shroud=no
        [/modify_side]

        {RECALL_ANYA_AT_LOCATION 11 10}
        {RECALL_DURVAN_AT_LOCATION 12 10}

        #
        # "Fix" Elynia, Anya and Durvan according to the
        # information stored at the end of E2.
        #

        {GET_GLOBAL episode2_stats_elynia persist_store}
        {BHS_UPDATE_PERSISTENTLY_STORED_UNIT Elynia}

        {GET_GLOBAL episode2_stats_anya persist_store}
        {BHS_UPDATE_PERSISTENTLY_STORED_UNIT Anya}

        {GET_GLOBAL episode2_stats_durvan persist_store}
        {BHS_UPDATE_PERSISTENTLY_STORED_UNIT Durvan}

        {CLEAR_VARIABLE persist_store}

        {MODIFY_UNIT (id=Anya) facing sw}
        {MODIFY_UNIT (id=Durvan) facing nw}

        {NAMED_UNIT 1 ("Elvish Druid") 8 9 Eluclya ( _ "Eluclya") (
            [modifications]
                {TRAIT_LOYAL}
                {TRAIT_STRONG}
            [/modifications]
        )} {NO_UPKEEP} {FACING se}

        {NAMED_UNIT 1 ("Elvish Fighter") 13 9 Nalan ( _ "Nalan") (
            [modifications]
                {TRAIT_LOYAL}
                {TRAIT_DEXTROUS}
            [/modifications]
        )} {NO_UPKEEP} {FACING sw}

        {NAMED_UNIT 1 ("Elvish Fighter") 10 8 Crendil ( _ "Crendil") (
            [modifications]
                {TRAIT_LOYAL}
                {TRAIT_RESILIENT}
            [/modifications]
        )} {NO_UPKEEP} {FACING s}
    [/event]

#undef BHS_UPDATE_PERSISTENTLY_STORED_UNIT

    [event]
        name=start

        [message]
            speaker=Eluclya
            message= _ "My lady, since you are going to return to the Far North we thought we should let you know you can count with our help. Should you need fighters or a healer..."
        [/message]

        [message]
            speaker=Elynia
            message= _ "I appreciate your offer, and you can come with us if you wish."
        [/message]

        [message]
            speaker=Durvan
            message= _ "Elynia, I’m not sure leaving most of our men behind is actually a good idea."
        [/message]

        [message]
            speaker=Elynia
            message= _ "I prefer that they stay here to search the ruins for us and assist the elves should our enemies send more troops back here. Anya can teleport them back to us later if necessary. We don’t have much time and we have already tarried here for too long because of my incompetence."
        [/message]

        [message]
            speaker=Anya
            message= _ "It’s not your fault! Teleporting is a very complicated and dangerous skill to learn for those who weren’t born with the ability!"
        [/message]

        {MODIFY_UNIT (id=Elynia) facing ne}

        [message]
            speaker=Elynia
            message= _ "I suppose it’s not my place to argue with a true being of the darkness. Fair enough — it’s time to leave. Proceed."
        [/message]

        [message]
            speaker=Anya
            message= _ "Very well!"
        [/message]

        [delay]
            time=200
        [/delay]

        {PUT_TO_RECALL_LIST (
            side=1
            race=elf
        )}

        [store_unit]
            [filter]
                id=Elynia
            [/filter]
            variable=elynia_store
            kill=yes
        [/store_unit]

        [store_unit]
            [filter]
                id=Anya
            [/filter]
            variable=anya_store
            kill=yes
        [/store_unit]

        [store_unit]
            [filter]
                id=Durvan
            [/filter]
            variable=durvan_store
            kill=yes
        [/store_unit]

        [redraw][/redraw]

        {BLACK_SCREEN}

        [terrain]
            # everything
            terrain=Xv
        [/terrain]

        [redraw][/redraw]

        [sound]
            name="magic-dark-big.ogg"
        [/sound]

        [delay]
            time=100
        [/delay]

        [sound]
            name="lightning.ogg"
        [/sound]

        [delay]
            time=2000
        [/delay]

        [replace_map]
            map="{LE /maps/01_2_A_Light_in_the_Darkness.map}"
            expand,shrink=yes,yes
        [/replace_map]

        [modify_side]
            side=1
            shroud=yes
        [/modify_side]


        # Items

#define BHS_IMG_FASTPATH _IMG _X _Y
        [item_fast]
            x={_X}
            y={_Y}
            image={_IMG}
        [/item_fast]
#enddef

        {BHS_IMG_FASTPATH "items/bones.png" 24 17}
        {BHS_IMG_FASTPATH "items/bones.png~FL(horiz)" 11 21}
        {BHS_IMG_FASTPATH "items/bones.png" 12 22}

        {BHS_IMG_FASTPATH "scenery/trash.png" 24 19}
        {BHS_IMG_FASTPATH "scenery/trash.png" 35 26}

        {BHS_IMG_FASTPATH "scenery/village-human-burned1.png" 12 16}
        {BHS_IMG_FASTPATH "scenery/village-human-burned4.png" 28 19}
        {BHS_IMG_FASTPATH "scenery/village-human-burned3.png" 22 13}
        {BHS_IMG_FASTPATH "scenery/village-human-burned2.png" 18 30}

        {BHS_IMG_FASTPATH "scenery/mine-abandoned.png" 40 8}

        {BHS_IMG_FASTPATH "scenery/rubble.png" 31 26}

        {BHS_IMG_FASTPATH "scenery/oak-leaning.png" 5 4}

        {BHS_IMG_FASTPATH "scenery/rock3.png" 31 6}
        {BHS_IMG_FASTPATH "scenery/rock1.png" 35 8}

        {BHS_IMG_FASTPATH "scenery/blood-trail-1.png" 41 26}
        {BHS_IMG_FASTPATH "scenery/blood-trail-2.png" 40 26}

        {BHS_IMG_FASTPATH "scenery/gore-3.png" 32 24}
        {BHS_IMG_FASTPATH "scenery/gore-3.png~FL(horiz)" 27 23}
        {BHS_IMG_FASTPATH "scenery/gore-2.png" 30 24}
        {BHS_IMG_FASTPATH "scenery/gore-1.png" 28 23}

#undef BHS_IMG_FASTPATH

        [set_variables]
            name=elynia_store
            mode=merge
            [literal]
                x,y,facing=41,24,se
            [/literal]
        [/set_variables]

        [set_variables]
            name=anya_store
            mode=merge
            [literal]
                x,y,facing=42,24,sw
            [/literal]
        [/set_variables]

        [set_variables]
            name=durvan_store
            mode=merge
            [literal]
                x,y,facing=41,25,ne
            [/literal]
        [/set_variables]

        [time_area]
            {UNDERGROUND}
            terrain=X*
            [or]
                x=34-48,33   ,30-32,37-38,43-44
                y=22-30,26-31,30-31,20   ,20
            [/or]
        [/time_area]

        [sound]
            name="magic-dark-big-miss.ogg"
        [/sound]

        {RESET_SCREEN}

        [unstore_unit]
            variable=elynia_store
        [/unstore_unit]

        [unstore_unit]
            variable=anya_store
        [/unstore_unit]

        [unstore_unit]
            variable=durvan_store
        [/unstore_unit]

        [redraw]
            side=1 # refresh shroud
        [/redraw]

        [delay]
            time=1000
        [/delay]

        #
        # FIXME: images for the trail of blood
        #

        [message]
            speaker=Durvan
            message= _ "Where are we? Where is everyone?"
        [/message]

        [message]
            speaker=narrator
            message= _ "While Anya and Durvan contemplate their surroundings, Elynia picks up a necklace identical to Anya’s, but covered in blood."
        [/message]

        [message]
            speaker=Anya
            message= _ "That trail... No..."
        [/message]

        [message]
            speaker=Elynia
            message= _ "This does not bode well."
        [/message]

        {MOVE_UNIT (id=Elynia) 38 27}
        {MODIFY_UNIT (id=Elynia) facing nw}

        {MOVE_UNIT (id=Durvan) 39 27}

        [delay]
            time=750
        [/delay]

        [message]
            speaker=Anya
            message= _ "Please tell me they’re not..."
        [/message]

        [message]
            speaker=Durvan
            message= _ "What’s behind the gate?"
        [/message]

        [unit]
            x,y=37,27
            side=6
            type=Door
            upkeep=free
            max_hitpoints=8
        [/unit]

        [animate_attack]
            [filter]
                x,y=37,27
            [/filter]
            [filter_second]
                id=Elynia
            [/filter_second]
            [filter_attack]
                name=faerie touch
            [/filter_attack]
            kill=yes
            animate=yes
            fire_event=no
            amount=8
            #experience=no
        [/animate_attack]

        [remove_terrain_overlays]
            x,y=37,27
        [/remove_terrain_overlays]

        [hide_unit][/hide_unit]

        {BLACK_SCREEN}

        [modify_side]
            side=1
            shroud=no
        [/modify_side]

        [scroll_to]
            x,y=26,22
        [/scroll_to]

        # Begin enemy sides set-up

        [modify_side]
            [filter_side]
                team_name=evil
            [/filter_side]
            hidden=no
        [/modify_side]

        [store_starting_location]
            side=3
        [/store_starting_location]

        [unit]
            canrecruit=yes
            type=Chaos Sharpshooter
            id=General Ramzal
            name= _ "General Ramzal"
            side=3
            x,y=$location.x,$location.y
            facing=se
            [modifications]
                {TRAIT_INTELLIGENT}
                {TRAIT_RESILIENT}
            [/modifications]
        [/unit]

        [store_starting_location]
            side=4
        [/store_starting_location]

        [unit]
            canrecruit=yes
            type=Gutwrencher Imp
            id=Sibul
            name= _ "Sibul"
            side=4
            x,y=$location.x,$location.y
            facing=sw
            [modifications]
                {TRAIT_STRONG}
                {TRAIT_SLOW}
            [/modifications]
        [/unit]

        [store_starting_location]
            side=5
        [/store_starting_location]

        [unit]
            canrecruit=yes
            type=Ancient Lich
            id=Mal Sultaria
            name= _ "Mal Sultaria"
            side=5
            x,y=$location.x,$location.y
            facing=ne
            [modifications]
                {TRAIT_UNDEAD}
            [/modifications]
        [/unit]

        # End enemy sides set-up

        [delay]
            time=500
        [/delay]

        {RESET_SCREEN}

        [unhide_unit][/unhide_unit]

        # Begin battlefield set-up

        [unit]
            side=2
            x,y=17,22
            hitpoints,experience=2,16
            facing=se
            type=Demon Grunt
            gender=male
            id=Amphael
            name= _ "Amphael"
            [modifications]
                {TRAIT_DEXTROUS}
                {TRAIT_QUICK}
            [/modifications]
        [/unit]

        [unit]
            side=3
            x,y=17,21
            experience=28
            facing=s
            type=Demon Stormtide
            gender=female
            name= _ "Vrena"
            [modifications]
                {TRAIT_DEXTROUS}
                {TRAIT_RESILIENT}
            [/modifications]
        [/unit]

        [unit]
            side=5
            x,y=17,23
            experience=28
            facing=n
            type=Demon Warrior
            gender=male
            name= _ "Saralmor"
            [modifications]
                {TRAIT_STRONG}
                {TRAIT_QUICK}
            [/modifications]
        [/unit]

        [unit]
            side=4
            x,y=25,25
            experience=6
            facing=se
            type=Chaos Razerman
            name= _ "Zulter"
            [modifications]
                {TRAIT_STRONG}
                {TRAIT_QUICK}
            [/modifications]
        [/unit]

        [unit]
            side=3
            x,y=26,26
            experience=2
            facing=nw
            type=Blood Imp
            name= _ "Sharghel"
            [modifications]
                {TRAIT_STRONG}
                {TRAIT_QUICK}
            [/modifications]
        [/unit]

        [unit]
            side=2
            x,y=25,26
            hitpoints,experience=11,4
            facing=
            type=Demon Zephyr
            gender=female
            name= _ "Riza"
            [modifications]
                {TRAIT_STRONG}
                {TRAIT_RESILIENT}
            [/modifications]
        [/unit]

        [unit]
            side=4
            x,y=27,21
            experience=27
            facing=se
            type=Hellhound
            [modifications]
                {TRAIT_QUICK}
                {TRAIT_RESILIENT}
            [/modifications]
        [/unit]

        [unit]
            side=2
            x,y=26,21
            hitpoints,experience=1,3
            facing=ne
            type=Fire Faerie
            name= _ "Malryne"
            [modifications]
                {TRAIT_INTELLIGENT}
                {TRAIT_QUICK}
            [/modifications]
        [/unit]

        [unit]
            side=5
            x,y=26,22
            experience=27
            facing=n
            type=Chaos Invader
            name= _ "Faras"
            [modifications]
                {TRAIT_STRONG}
                {TRAIT_QUICK}
            [/modifications]
        [/unit]

        [unit]
            side=3
            x,y=14,9
            experience=13
            hitpoints=34
            facing=se
            type=Demon Zephyr
            name= _ "Vulmorse"
            [modifications]
                {TRAIT_RESILIENT}
                {TRAIT_STRONG}
            [/modifications]
        [/unit]

        [unit]
            side=2
            x,y=15,10
            hitpoints,experience=3,5
            facing=nw
            type=Demon
            gender=male
            name= _ "El-Daghard"
            [modifications]
                {TRAIT_RESILIENT}
                {TRAIT_DEXTROUS}
            [/modifications]
        [/unit]

        [unit]
            side=3
            x,y=16,10
            experience=9
            facing=nw
            type=Blood Imp
            name= _ "Knox"
            [modifications]
                {TRAIT_STRONG}
                {TRAIT_DIM}
            [/modifications]
        [/unit]

        [unit]
            side=3
            x,y=18,19
            facing=sw
            type=Demon Stormtide
            gender=female
            name= _ "Shege Ros"
            [modifications]
                {TRAIT_RESILIENT}
                {TRAIT_QUICK}
            [/modifications]
        [/unit]

        [unit]
            side=5
            x,y=25,15
            facing=sw
            type=Shaxthal Runner Drone
            variation=surface
            [modifications]
                {TRAIT_BIOMECHANICAL}
                {TRAIT_ARMORED}
            [/modifications]
        [/unit]

        [unit]
            side=3
            x,y=17,13
            facing=se
            type=Chaos Invoker
            name= _ "Azora"
            [modifications]
                {TRAIT_STRONG}
                {TRAIT_RESILIENT}
            [/modifications]
        [/unit]

        [unit]
            side=3
            x,y=7,4
            facing=nw
            type=Demon Zephyr
            name= _ "Mith’roy"
            [modifications]
                {TRAIT_QUICK}
                {TRAIT_DEXTROUS}
            [/modifications]
        [/unit]

        [unit]
            side=3
            x,y=32,9
            facing=sw
            type=Demon Stormtide
            name= _ "Kalehmar"
            [modifications]
                {TRAIT_INTELLIGENT}
                {TRAIT_STRONG}
            [/modifications]
        [/unit]

        [unit]
            side=5
            x,y=8,18
            facing=nw
            gender=female
            type=Demon Warrior
            name= _ "Zharmel"
            [modifications]
                {TRAIT_DEXTROUS}
                {TRAIT_QUICK}
            [/modifications]
        [/unit]

        [unit]
            side=5
            x,y=12,24
            facing=sw
            type=Imp
            name= _ "Drogor"
            [modifications]
                {TRAIT_SLOW}
                {TRAIT_DIM}
            [/modifications]
        [/unit]

        [unit]
            side=5
            x,y=29,17
            facing=s
            type=Chaos Bowman
            name= _ "Elannar"
            [modifications]
                {TRAIT_STRONG}
                {TRAIT_QUICK}
            [/modifications]
        [/unit]

        [unit]
            side=5
            x,y=24,18
            facing=se
            type=Chaos Invoker
            name= _ "Normagen"
            [modifications]
                {TRAIT_INTELLIGENT}
                {TRAIT_RESILIENT}
            [/modifications]
        [/unit]

        [unit]
            side=4
            x,y=33,10
            facing=sw
            type=Demon Grunt
            gender=female
            name= _ "Quar"
            [modifications]
                {TRAIT_DEXTROUS}
                {TRAIT_INTELLIGENT}
            [/modifications]
        [/unit]

        [unit]
            side=2
            x,y=19,16
            facing=se
            type=Rock Golem
            hitpoints=13
            experience=6
            [modifications]
                {TRAIT_SPIRIT}
            [/modifications]
        [/unit]

        [unit]
            side=2
            x,y=26,23
            facing=nw
            type=Animated Rock
            hitpoints=2
            experience=5
            [modifications]
                {TRAIT_SPIRIT}
            [/modifications]
        [/unit]

        [unit]
            side=2
            x,y=11,22
            facing=se
            type=Animated Rock
            hitpoints=7
            experience=2
            [modifications]
                {TRAIT_SPIRIT}
            [/modifications]
        [/unit]

        # Guardians

        [unit]
            side=4
            ai_special=guardian
            upkeep=free
            x,y=38,6
            facing=sw
            type=Demon Zephyr
            name= _ "Malkor"
            [modifications]
                {TRAIT_RESILIENT}
                {TRAIT_QUICK}
            [/modifications]
        [/unit]

#ifndef EASY
        [unit]
            side=4
            ai_special=guardian
            upkeep=free
            x,y=33,5
            facing=se
            type=Demon Grunt
            gender=female
            name= _ "Kyanala"
            [modifications]
                {TRAIT_STRONG}
                {TRAIT_INTELLIGENT}
            [/modifications]
        [/unit]

        [unit]
            side=4
            ai_special=guardian
            upkeep=free
            x,y=37,10
            facing=nw
            type=Demon Grunt
            gender=female
            name= _ "Shergal"
            [modifications]
                {TRAIT_STRONG}
                {TRAIT_DEXTROUS}
            [/modifications]
        [/unit]
#endif

        # Redraw

        [redraw][/redraw]

        # End battlefield set-up

        #
        # FIXME: more gory crap here
        #

        {REPLACE_SCENARIO_MUSIC ("heroes_rite.ogg")}

        #
        # FIXME: more dialog
        #

        [fire_event]
            name=begin gameplay
        [/fire_event]
    [/event]

    [event]
        name=begin gameplay
        [modify_turns]
            {QUANTITY value 24 22 20}
        [/modify_turns]

        [modify_side]
            side=1
            {GOLD 180 160 150}
            income=0
            village_gold=1
        [/modify_side]

        {OBJECTIVES (
            {OBJECTIVE_VICTORY ( _ "Defeat all enemy leaders")}

            {OBJECTIVE_DEFEAT  ( _ "Death of Elynia")}
            {OBJECTIVE_DEFEAT  ( _ "Death of Anya")}
            {OBJECTIVE_DEFEAT  ( _ "Death of Durvan")}

            {TURNS_RUN_OUT}
        )}
    [/event]

    [event]
        name=enemies defeated
        {ENDLEVEL_VICTORY yes}
    [/event]

    [event]
        name=victory
    [/event]
    
[/scenario]

# kate: indent-mode normal; encoding utf-8; space-indent on;
